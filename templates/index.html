<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathfinder Python Web Editor</title>

    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <!-- CSS Files -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/widget.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/editor.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/util.css') }}">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- GridStack.js 12.2.2 -->
    <link href="https://cdn.jsdelivr.net/npm/gridstack@12.2.2/dist/gridstack.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/gridstack@12.2.2/dist/gridstack-all.js"></script>
</head>
<body>
    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Header -->
        <header class="header">
            <h1>
                <i class="fas fa-code"></i>
                Pathfinder Python Web Editor
            </h1>
            <div class="status-info">
                <div class="status-item">
                    <div class="status-dot error" id="statusDot"></div>
                    <span id="statusText">Disconnected</span>
                </div>
            </div>
            <div class="header-controls">
                <button class="btn btn-primary" id="addWidgetBtn">
                    <i class="fas fa-plus"></i>
                    Add Widget
                </button>
                <button class="btn btn-secondary" id="widgetSettingsBtn">
                    <i class="fas fa-cog"></i>
                    Settings
                </button>
                <button class="btn btn-warning" id="clearAllWidgetsBtn">
                    <i class="fas fa-trash"></i>
                    Clear All
                </button>
            </div>
        </header>

        <!-- GridStack Container -->
        <section class="gridstack-section">
            <div class="grid-stack" id="mainGridStack">
                <!-- Code Editor Widget -->
                <div class="grid-stack-item" id="codeEditorWidget" gs-w="17" gs-h="20" gs-x="0" gs-y="0" gs-min-w="10" gs-min-h="5" gs-auto-position="false" gs-locked="true"> <!-- 위치 변경 금지 -->
                    <div class="grid-stack-item-content widget-content">
                        <div class="widget-header">
                            <h4><i class="fas fa-code"></i> Code Editor</h4>
                            <div class="widget-controls">
                                <span class="execution-status" id="executionStatus">대기 중</span>
                                <button class="btn btn-small btn-success" id="runBtn">
                                    <i class="fas fa-play"></i> Run
                                </button>
                                <button class="btn btn-small btn-danger" id="stopBtn">
                                    <i class="fas fa-stop"></i> Stop
                                </button>
                                <button class="btn btn-small btn-secondary">
                                    <i class="fas fa-save"></i> Save
                                </button>
                            </div>
                        </div>
                        <div class="widget-body">
                            <div id="monaco-editor" class="monaco-editor"></div>
                        </div>
                    </div>
                </div>

                <!-- Output Panel Widget -->
                <div class="grid-stack-item" id="outputPanelWidget" gs-w="17" gs-h="10" gs-x="0" gs-y="20" gs-min-w="10" gs-min-h="5" gs-locked="true"> <!-- 위치 변경 금지 -->
                    <div class="grid-stack-item-content widget-content">
                        <div class="widget-header">
                            <h4><i class="fas fa-terminal"></i> Output</h4>
                            <div class="widget-controls">
                                <button class="btn btn-small" id="clearOutputBtn">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                            </div>
                        </div>
                        <div class="widget-body">
                            <div class="output-content" id="outputContent">
                                <div class="output-item system">Findee Python Web Editor!</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image Display Widget -->
                <div class="grid-stack-item" id="imageDisplayWidget" gs-w="17" gs-h="15" gs-x="0" gs-y="30" gs-min-w="8" gs-min-h="8" gs-locked="false">
                    <div class="grid-stack-item-content widget-content">
                        <div class="widget-header">
                            <h4><i class="fas fa-image"></i> Image Display</h4>
                            <div class="widget-controls">
                                <button class="btn btn-small btn-secondary" onclick="refreshImageWidget()">
                                    <i class="fas fa-sync"></i> Refresh
                                </button>
                                <button class="btn btn-small btn-secondary" onclick="clearImageWidget()">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                            </div>
                        </div>
                        <div class="widget-body">
                            <div class="image-display" id="imageDisplay">
                                <div class="placeholder-text">이미지가 여기에 표시됩니다</div>
                                <img id="displayImage" src="" alt="Display Image" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Custom JavaScript -->
    <script src="{{ url_for('static', filename='js/util.js') }}"></script>
    <script src="{{ url_for('static', filename='js/editor.js') }}"></script>
    <script src="{{ url_for('static', filename='js/action.js') }}"></script>

    <script src="{{ url_for('static', filename='js/widget.js') }}"></script>
    <script src="{{ url_for('static', filename='js/socket-handler.js') }}"></script>

    <script>
        showWelcomeToast(0); // util.js

        document.addEventListener('DOMContentLoaded', function() {
            console.info('DOM Content Loaded');

            try {
                // Monaco Editor 초기화
                if (typeof initializeMonacoEditor === 'function') {
                    initializeMonacoEditor(); // editor.js
                } else {
                    console.error('initializeMonacoEditor function not found');
                }

                // Socket 초기화
                if (typeof initializeSocket === 'function') {
                    initializeSocket(); // socket-handler.js
                }

                // GridStack 초기화
                if (typeof GridStack !== 'undefined') {
                    console.log('GridStack is available');
                    const grid = initializeMainGridStack();
                    if (grid) {
                        console.log('Main GridStack initialized successfully');
                    } else {
                        console.error('Failed to initialize Main GridStack');
                    }
                } else {
                    console.error('GridStack is not loaded');
                }

                // 버튼 이벤트 리스너 등록
                const runButton = document.getElementById('runBtn');
                if (runButton && typeof handleRunButtonClick === 'function') {
                    runButton.addEventListener('click', handleRunButtonClick);
                }

                const stopButton = document.getElementById('stopBtn');
                if (stopButton && typeof handleStopButtonClick === 'function') {
                    stopButton.addEventListener('click', handleStopButtonClick);
                }

                const clearOutputBtn = document.getElementById('clearOutputBtn');
                if (clearOutputBtn && typeof clearOutput === 'function') {
                    clearOutputBtn.addEventListener('click', clearOutput);
                }

            } catch (error) {
                console.error('Error during initialization:', error);
            }
        });
    </script>
</body>
</html>
